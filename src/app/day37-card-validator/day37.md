# Day 37: カード番号バリデータ（学生向け解説）

## ゴール
- クレジットカード番号が正しい形式かを「Luhn（ルーン）アルゴリズム」で判定できる
- 番号からカードブランド（VISA / Mastercard / AMEX など）を推定できる
- 入力を読みやすく整形（グルーピング）できる

---

## なぜ必要？（身近なたとえ）
カード番号には「最後に“答え合わせ”用の数字（チェックディジット）」が付いています。これは「ミスに気づくための仕組み」。例えば学生証の番号に“検査用の桁”があるイメージです。数字を少し打ち間違えると、この“検査”に引っかかり、無効と判定できます。

---

## Luhn アルゴリズム（やさしい説明）
1. 右端（チェックディジット）から左へ向かって数え、2つおき（=右から2番目、4番目…）の数字を2倍にします。
2. 2倍にして10以上になったら、その数字から9を引きます（例: 8→16→16−9=7）。
3. すべての数字を合計します。
4. 合計が10で割り切れれば「有効（Valid）」です。

ポイント: 「2倍→10以上なら9を引く」を覚えればOK。実装はループ1本で書けます。

---

## ブランド判定（ざっくりルール）
| ブランド | 先頭桁（範囲） | 桁数の目安 |
|---|---|---|
| VISA | 4 で始まる | 13〜19桁 |
| Mastercard | 51〜55 または 2221〜2720 | 16桁 |
| AMEX | 34 または 37 | 15桁 |
| Discover | 6011 または 65 | 16桁 |
| JCB | 3528〜3589 | 16桁 |
| Diners | 300〜305, 36, 38 | 14桁 |

本アプリでは上記の“よく使う範囲”でざっくり判定します（完全網羅ではありません）。

---

## 整形（フォーマット）の考え方
- AMEX: 4-6-5 のグループ（例: 3782 822463 10005）
- それ以外: 4桁ずつ区切り（例: 4111 1111 1111 1111）

入力自体は「数字のみ」で扱い、表示のときだけスペースを入れて見やすくしています。

---

## このアプリの構成（読めば理解できる）
- `utils/cardUtils.ts`
  - `normalizeDigits(input)`: 数字以外を取り除く
  - `detectBrand(digits)`: 先頭の桁パターンからブランド推定
  - `formatByBrand(digits, brand)`: ブランドごとの見た目に整形
  - `luhnCheck(digits)`: Luhn アルゴリズムによる検証
  - `validateCard(input)`: 上記をまとめて1回で評価
- `components/CardValidatorApp.tsx`
  - 入力（テキストボックス）と検査結果（ブランド/整形/Luhn判定）を表示

---

## 試してみよう（学習用サンプル）
以下は“テスト用の番号（ダミー）”としてよく使われるものです。実在のカードではありません。
- VISA: `4111 1111 1111 1111`
- Mastercard: `5555 5555 5555 4444`
- AMEX: `3782 822463 10005`
- Discover: `6011 1111 1111 1117`
- JCB: `3530 1113 3330 0000`
- Diners: `3056 9309 0259 04`

学習のコツ: 末尾（チェックディジット）を 1 桁だけ変えてみて、Luhn が「無効」になることを確かめてください。

---

## よくある質問（Q&A）
- Q: 13桁でも VISA になるの？
  - A: 仕様上はありえます。ブランドや発行時期で桁数が揺れます。ここでは一般的な範囲で扱っています。
- Q: ブランドは完全に当たる？
  - A: いいえ、BINの最新情報などは反映していないため“推定”です。厳密には外部データが必要です。
- Q: セキュリティ上の注意は？
  - A: 入力値をサーバーに送らない（フロントのみで判定）、ログに書かない、保存しない、を徹底しましょう。

---

## 練習課題
1. 入力中に自動でスペース整形（AMEXは 4-6-5、それ以外は 4桁おき）を入れてみよう。
2. 先頭6桁（BIN）から発行会社名を表示できるように拡張（モックデータでOK）。
3. 入力のマスキング（例: 表示は `**** **** **** 1234`）を実装してみよう。

---

## まとめ
- Luhn は「足して 10 の倍数」になれば OK という“検査の仕組み”。
- ブランドは先頭桁のパターンで“おおまかに”推定できる。
- 表示は“人が読みやすい形”に整形するのが実務でも大事（ミスを減らす）。
